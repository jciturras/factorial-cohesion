---
title: "Factorial desing"
date: "`r format(Sys.time(), '%A %d %B %Y %X')`"
author: Julio Iturra
output: 
  html_document:
     theme: flatly
     highlight: tango
     toc: true
     toc_float: true
     toc_depth: 2
     number_sections: false
     code_folding: hide
---
# Vignette design

1. [Draft Google Docs](https://docs.google.com/document/d/1Tn_vZTNaxIOeK5lHcQkPWt3Knw_OqKIEe7pPf19CI4c/edit) 
2. Code in SAS (https://odamid-euw1.oda.sas.com/)
3. Macro (https://support.sas.com/rnd/app/macros/MktEx/MktEx.pdf)

```{r, eval=FALSE, include=TRUE}
%mktruns(2 3 3 4 3 3 3 4 4)
Saturated      = 21                                       
Full Factorial = 31,104                                   
Some Reasonable                      Cannot Be            
   Design Sizes       Violations     Divided By           
            144 *              0                          
             72                3     16                   
            216                3     16                   
             36                6      8 16                
            108                6      8 16                
            180                6      8 16                
             48               10      9                   
             96               10      9                   
            192               10      9                   
             24               13      9 16                
             21 S             40      2  4  6  8  9 12 16 
 - 100% Efficient design can be made with the MktEx macro.
 - Saturated Design - The smallest design that can be made.
   Note that the saturated design is not one of the       
   recommended designs for this problem.  It is shown     
   to provide some context for the recommended sizes.     

```

```{r, eval=FALSE, include=TRUE}
%mktex(2 3 3 4 3 3 3 4 4, n=144, seed=2624)
     Design    Row,Col  D-Efficiency  D-Efficiency  Notes                                    
     ----------------------------------------------------------                              
          1      Start      100.0000      100.0000  Tab                                      
          1        End      100.0000
```


```{r, eval=FALSE, include=TRUE}
%mktblock(data=Randomized, nblocks=10, seed=2624) # 10 decks
/* 10 decks, 4 decks with 15 vignettes and 6 decks with 14 vignettes  */

%mktblock(data=Randomized, nblocks=15, seed=2624) # 15 decks
/* 15 decks, 9 decks with 10 vignettes and 6 decks with 9 vignettes  */
```


# Generation of the vignettes

- First we load the file containing the vignette information generated in SAS.

```{r,warning=FALSE,message=F}
if (!require("pacman")) install.packages("pacman") # instalar pacman
pacman::p_load(readxl,dplyr,knitr,kableExtra)

# df_vig <- xlsx::read.xlsx(file = "../input/vignetas.xlsx",sheetIndex = 1)
df_vig <- xlsx::read.xlsx(file = "../input/vignetas15.xlsx",sheetIndex = 1)

colnames = c("obs","deck","vig","gender", "age", "migration", "religion", "education", "employment_status", "income", "political_orientation", "cultural_values")
names(df_vig) <- colnames
names(df_vig)
vig_dat<- df_vig %>% mutate(deck_vig=paste0(deck,vig)) %>% select(obs,deck,vig,deck_vig,everything())
```
- Save the vignette information for later use in the analysis.

```{r,warning=FALSE}
save(vig_dat,file = here::here("input/data/proc/vig_dim.RData"))
```


## Labels

-  level labelling for text generation


EN
Person [ID] is [Gender] and [Age] years old. [She/he] was born in [Migration Background] an is [Religion]. Person [ID] has completed [Education], is [Employment Status] and has a monthly income of [Income] at [her/his] disposal. [She/he] sees [herself/himself] politically [Political Orientation]. To person [ID], it is important to [Value Orientation].


```{r,warning=FALSE,message=F}
df_vig <- 
df_vig %>% 
    mutate(
      letter = recode(
        vig,
        `1` = "A",
        `2` = "B",
        `3` = "C",
        `4` = "D",
        `5` = "E",
        `6` = "F",
        `7` = "G",
        `8` = "H",
        `9` = "I",
        `10` = "J",        
      ),
      gender = recode(gender, `1` = "man", `2` = "woman"),
      age = recode(
        age,
        `1` = "35 years old.",
        `2` = "45 years old.",
        `3` = "65 years old."
      ),
      migration  = recode(
        migration,
        `1` = "Germany, has German parents",
        `2` = "Germany, has Turkish parents",
        `3` = "Syria, came to Germany"
      ),
      religion = recode(
        religion,
        `1` = "a devout Christian.",
        `2` = "a devout Muslim",
        `3` = "a devout Jew.",
        `4` = "not religious."
      ),
      education  = recode(
        education,
        `1` = "did an apprenticeship after finishing secondary school,",
        `2` = "has completed vocational training after finishing secondary school,",
        `3` = "has studied at university after graduating from high school,",
      ),
      income = recode(
        income,
        `1` = "850€",
        `2` = "2,500€",
        `3` = "6,000€",
      ),
      employment_status = recode(
        employment_status,
        `1` = "employed full-time",
        `2` = "unemployed.",
        `3` = "homemaker."
      ),
      political_orientation = recode(
        political_orientation,
        `1` = "standing on the left.",
        `2` = "standing in the middle.",
        `3` = "standing on the right.",
        `4` = "as uninterested."
      ),
      cultural_values = recode(
        cultural_values,
        `1` = "being tolerant and to help people around.",
        `2` = "feel safe, to fit in with others and to respect traditions.",
        `3` = "reach personal achievements and to be in charge.",
        `4` = "to make your own decisions and lead an entertaining and adventurous life."
      )      
    )

table(df_vig$education)
table(df_vig$migration=="Syria,came to Germany" & df_vig$education =="has completed vocational training after finishing secondary school,")

df_vig$education <-
  ifelse(
    df_vig$migration == "Syria,came to Germany" &
      df_vig$education == "has completed vocational training after finishing secondary school,",
    yes = "qualified vocational training,",
    df_vig$education
  )
table(df_vig$education)

df_vig$education <-
  ifelse(
    df_vig$migration=="Syria,came to Germany" & 
      df_vig$education =="has studied at university after graduating from high school,",
    yes = "a university degree course,",
    df_vig$education
  )

table(df_vig$education)

df_vig$he_she <- ifelse(df_vig$gender=="man",yes = "He",no = "She")
df_vig$himself_herself <- ifelse(df_vig$gender=="man",yes = "himself",no = "herself")
df_vig$his_her <- ifelse(df_vig$gender=="man",yes = "his",no = "her")

"Person [ID] is [Gender] and [Age] years old. [She/he] was born in [Migration Background] an is [Religion]. Person [ID] has completed [Education], is [Employment Status] and has a monthly income of [Income] at [her/his] disposal. [She/he] sees [herself/himself] politically [Political Orientation]. To person [ID], it is important to [Value Orientation]."

paste("Person",df_vig$letter,"is a",df_vig$gender,"and is",df_vig$age,df_vig$he_she,"was born in",df_vig$migration,"and is",df_vig$religion,
      "Person",df_vig$letter,df_vig$education,"and has a monthly income of",df_vig$income,"at",df_vig$his_her,"disposal.",
      df_vig$he_she,"sees",df_vig$himself_herself,"politically",df_vig$political_orientation,
      "To person",df_vig$letter,"it is important to",df_vig$cultural_values)

# sjmisc::flat_table(table(df_vig$income,df_vig$employment_status))
# df_vig %>% select(gender:cultural_values) %>% polycor::hetcor()

df_vig %>% group_by(deck) %>% 
  summarise(vig=n()) %>% 
  kable(col.names = c("Deck","Number of vignettes")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Text generation

- These are some examples (random sample of 30 cases) that include the complete desing

```{r echo=FALSE, results='asis'}
df_vig <- 
    df_vig %>% 
    mutate(vig_text = paste(gender, age, migration, religion,education, income, employment_status,political_orientation,cultural_values)) %>% 
    ungroup()
df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Sophia",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "SUS",
      replacement = "She"
    ),
    no = df_vig$vig_text
  )
df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Jan",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "SUS",
      replacement = "He"
    ),
    no = df_vig$vig_text
  )

df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Sophia",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "SUB",
      replacement = "she"
    ),
    no = df_vig$vig_text
  )
df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Jan",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "SUB",
      replacement = "he"
    ),
    no = df_vig$vig_text
  )


df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Sophia",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "PRON",
      replacement = "herself"
    ),
    no = df_vig$vig_text
  )
df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Jan",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "PRON",
      replacement = "himself"
    ),
    no = df_vig$vig_text
  )

df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Sophia",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "GENDER3",
      replacement = "her"
    ),
    no = df_vig$vig_text
  )
df_vig$vig_text <-
  ifelse(
    df_vig$gender == "Jan",
    yes = stringr::str_replace_all(
      string = df_vig$vig_text,
      pattern = "GENDER3",
      replacement = "him"
    ),
    no = df_vig$vig_text
  )

df_vig %>% 
  select(vig_text) %>% 
  mutate(Example=paste(vig_text)) %>% 
  sample_n(size = 30) %>% 
  select(Example) %>% 
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```


DE: 

Person [ID] ist [Geschlecht] und [Alter] Jahre alt. Sie ist in [Migrationshintergrund] und ist [Religion (+Geschlecht)]. Person [ID] hat [Bildung + (Migrationshintergrund)] absolviert, ist [Erwerbsstatus (+Geschlecht)] und verfügt über ein monatliches Einkommen von [Einkommen]. Sie versteht sich selbst als politisch [Polititische Orientierung]. Es ist Person [ID] wichtig, [Wertorientierung].


```{r}
devtools::install_github("zumbov2/deeplr")
my_key <- "8aa9d9db-f3bd-fe6e-089e-8e16786ad7ab:fx"

langs <- deeplr::available_languages2(my_key)

df_vig$vig_text_noname_DE <- df_vig$vig_text_noname

df_vig$vig_text_noname_DE <-
deeplr::translate2(
  text = df_vig$vig_text_noname,
  target_lang = "DE",
  auth_key = my_key
  )
```


```{r}
df_vig %>% select(obs:vig,vig_text_noname,vig_text_noname_DE) %>% 
  xlsx::write.xlsx(file = "../output/vignettes.xlsx")
```

